<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RainCall+</title>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1163/1163657.png">
    <style>
        body { 
            /* é›¨ãªã‚‰é’ç³»ã€æ™´ã‚Œãªã‚‰ãƒ”ãƒ³ã‚¯ç³»ã®èƒŒæ™¯ã«è‡ªå‹•ã§å¤‰ã‚ã‚Šã¾ã™ */
            background: {% if pop >= 30 %}linear-gradient(135deg, #4facfe 0%, #00f2fe 100%){% else %}linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%){% endif %};
            font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; 
        }
        .card { background: rgba(255,255,255,0.9); border-radius: 30px; padding: 40px; text-align: center; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        h1 { color: #333; font-size: 20px; margin-bottom: 20px; }
        .pop { font-size: 70px; font-weight: bold; color: #00838f; margin: 10px 0; }
        .notify-btn {
            background: #ff7043; color: white; border: none; padding: 10px; border-radius: 12px;
            cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 20px;
        }
        .location-tag { display: inline-block; background: #333; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="card">
        <h1>RainCall+</h1>
        
        <button onclick="askNotificationPermission()" class="notify-btn">
            ğŸ”” é›¨äºˆå ±ã®é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã™ã‚‹
        </button>

        <div class="pop">{{ pop }}%</div>
        <p style="font-weight: bold;">{{ message }}</p>
        <div class="location-tag">ğŸ“ {{ city }}</div>
    </div>

    <script>
        // é€šçŸ¥ã®å‡¦ç†
        function askNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    alert("é€šçŸ¥è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                    checkRainAndNotify();
                }
            });
        }

        function checkRainAndNotify() {
            const pop = {{ pop }};
            if (pop >= 30) {
                new Notification("RainCall+", {
                    body: `ä»Šæ—¥ã¯é›¨ãŒé™ã‚Šãã†ï¼ˆ${pop}%ï¼‰ã ã‚ˆï¼å‚˜ã‚’å¿˜ã‚Œãšã«ã€‚â˜”`,
                    icon: "https://cdn-icons-png.flaticon.com/512/1163/1163657.png"
                });
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.onload = function() {
            if (Notification.permission === "granted") {
                checkRainAndNotify();
            }

            // URLã«ä½ç½®æƒ…å ±ãŒãªã„å ´åˆã ã‘å–å¾—ã—ã«è¡Œãï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('lat')) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        window.location.href = `/?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`;
                    },
                    () => { console.log("ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"); }
                );
            }
        };
    </script>
</body>
</html>